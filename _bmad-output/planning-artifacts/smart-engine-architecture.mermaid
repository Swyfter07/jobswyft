graph TD
    subgraph "Client-Side (Chrome Extension)"
        Page[Job Application Page]
        
        subgraph "Detection Pipeline (Graceful Degradation)"
            L0[Layer 0: URL Pattern] -->|Match| L1
            L0 -->|No Match| Stop[Idle]
            
            L1[Layer 1: Metadata/JSON-LD] -->|Complete?| Fill[Ready to Autofill]
            L1 -->|Incomplete| L2
            
            L2[Layer 2: Strict Selectors] -->|Checking Registry...| L2Check{Found?}
            L2Check -->|Yes| Fill
            L2Check -->|No| L3
            
            L3[Layer 3: Heuristics/Fuzzy] -->|Confidence > 80%?| Fill
            L3 -->|Low Confidence| L4
        end
        
        subgraph "User Loop"
            Fill -->|Success| UserHappy[User Reviews]
            Fill -->|Fail/Miss| UserCorrect[User 'Point & Click' Correction]
            UserCorrect --> LocalStore[(Local Config)]
            LocalStore -.->|Override| L2
        end
        
        ConfigSync[Config Sync Manager] -->|Updates| ExtensionStore[(Extension Storage)]
        ExtensionStore --> L2
    end
    
    subgraph "Backend Services"
        API_L4[Layer 4: AI Extraction API]
        ConfigAPI[Config Delivery API]
        FeedbackAPI[Feedback Ingestion]
        
        L4 -->|HTML Snapshot| API_L4
        API_L4 -->|Structured Data| Fill
        
        UserCorrect -.->|Opt-in Report| FeedbackAPI
        ConfigSync <-->|Fetch Delta| ConfigAPI
    end
    
    subgraph "Development & Learning Loop"
        FeedbackAPI --> Analysis[Aggregated Failures]
        Analysis --> LLM_Dev[LLM / Developer]
        LLM_Dev -->|Test Fix| Harness[Test Harness (jsdom)]
        Harness -->|Verify| MasterConfig[Master Selector Registry]
        MasterConfig -->|Publish| ConfigAPI
    end

    style L0 fill:#e1f5fe,stroke:#01579b
    style L1 fill:#e1f5fe,stroke:#01579b
    style L2 fill:#b3e5fc,stroke:#0277bd
    style L3 fill:#81d4fa,stroke:#0288d1
    style L4 fill:#4fc3f7,stroke:#039be5
    style Fill fill:#a5d6a7,stroke:#2e7d32
    style UserCorrect fill:#fff9c4,stroke:#fbc02d
    style MasterConfig fill:#f8bbd0,stroke:#c2185b
